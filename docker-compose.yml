services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: edx_mysql
    environment:
      MYSQL_ROOT_PASSWORD: 1234
      MYSQL_DATABASE: edxapp
    ports:
      - "3308:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - edx_network

  # MongoDB Database
  mongodb:
    image: mongo:6.0
    container_name: edx_mongodb
    command: mongod --noauth
    ports:
      - "27019:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - edx_network

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: edx_redis
    ports:
      - "6381:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - edx_network

  # Memcached Cache
  memcached:
    image: memcached:1.6-alpine
    container_name: edx_memcached
    ports:
      - "11213:11211"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "11211"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - edx_network

  # Open edX LMS
  lms:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: edx_lms
    ports:
      - "18000:18000"
    environment:
      - LMS_CFG=/app/lms.env.docker.yml
      - CMS_CFG=/app/cms.env.docker.yml
      - DJANGO_SETTINGS_MODULE=lms.envs.devstack
    volumes:
      - .:/app
      - ./lms.env.docker.yml:/app/lms.env.docker.yml
      - ./cms.env.docker.yml:/app/cms.env.docker.yml
      - staticfiles_data:/app/staticfiles
      - logs_data:/app/logs
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      sh -c "
        echo 'Building webpack assets...' &&
        export STATIC_ROOT_LMS=/app/staticfiles &&
        export STATIC_ROOT_CMS=/app/staticfiles/studio &&
        npm run webpack-dev || echo 'Webpack build skipped or completed' &&
        echo 'Running LMS migrations...' &&
        python manage.py lms migrate --settings=devstack || echo 'Migrations completed with warnings' &&
        echo 'Running LMS student module history migrations...' &&
        python manage.py lms migrate --database=student_module_history --settings=devstack || echo 'Student module history migrations completed with warnings' &&
        echo 'Ensuring theming migrations are applied...' &&
        python manage.py lms migrate theming --settings=devstack || echo 'Theming migrations check completed' &&
        echo 'Creating Site record...' &&
        echo 'Migrations complete. Pulling static files...' &&
        make pull_translations || echo 'Translations pull skipped' &&
        python manage.py lms collectstatic --noinput --settings=devstack &&
        echo 'Static files pulled. Starting server...' &&
        python manage.py lms runserver 0.0.0.0:18000 --settings=devstack
      "
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:18000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - edx_network

  # Open edX CMS (Studio)
  cms:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: edx_cms
    ports:
      - "18010:18010"
    environment:
      - LMS_CFG=/app/lms.env.docker.yml
      - CMS_CFG=/app/cms.env.docker.yml
      - DJANGO_SETTINGS_MODULE=cms.envs.devstack
    volumes:
      - .:/app
      - ./lms.env.docker.yml:/app/lms.env.docker.yml
      - ./cms.env.docker.yml:/app/cms.env.docker.yml
      - staticfiles_data:/app/staticfiles
      - logs_data:/app/logs
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      lms:
        condition: service_healthy
    command: >
      sh -c "
        echo 'Building webpack assets...' &&
        export STATIC_ROOT_LMS=/app/staticfiles &&
        export STATIC_ROOT_CMS=/app/staticfiles/studio &&
        npm run webpack-dev || echo 'Webpack build skipped or completed' &&
        echo 'Running migrations...' &&
        python manage.py cms migrate --settings=devstack || echo 'Some migrations may have failed' &&
        echo 'Creating Site record...' &&
        echo 'Migrations complete. Creating studio_worker user...' &&
        python manage.py lms manage_user studio_worker studioworker@gmail.com --unusable-password --settings=devstack || echo 'User creation skipped (may already exist)' &&
        echo 'Setting password for studio_worker user...' &&
        printf 'import os\nimport django\nos.environ.setdefault("DJANGO_SETTINGS_MODULE", "lms.envs.devstack")\ndjango.setup()\nfrom django.contrib.auth import get_user_model\nUser = get_user_model()\ntry:\n    u = User.objects.get(username="studio_worker")\n    u.set_password("Admin@123")\n    u.save()\n    print("Password set successfully")\nexcept User.DoesNotExist:\n    print("User not found")\nexcept Exception as e:\n    print(f"Error: {e}")\n' > /tmp/set_pwd.py && python /tmp/set_pwd.py || echo 'Password setting skipped' && rm -f /tmp/set_pwd.py &&
        echo 'Creating dot application for studio-sso-id...' &&
        python manage.py lms create_dot_application studio-sso-id studio_worker \
          --grant-type authorization-code \
          --skip-authorization \
          --redirect-uris 'http://localhost:18010/complete/edx-oauth2/' \
          --scopes user_id \
          --client-id 'studio-sso-id' \
          --client-secret 'studio-sso-secret' \
          --settings=devstack || echo 'Dot application creation skipped (may already exist)' &&
        echo 'Pulling static files...' &&
        python manage.py cms collectstatic --noinput --settings=devstack &&
        echo 'Static files pulled. Starting server...' &&
        python manage.py cms runserver 0.0.0.0:18010 --settings=devstack
      "
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:18010 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - edx_network

  # Celery Worker (LMS)
  celery_lms:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: edx_celery_lms
    environment:
      - LMS_CFG=/app/lms.env.docker.yml
      - CMS_CFG=/app/cms.env.docker.yml
      - DJANGO_SETTINGS_MODULE=lms.envs.devstack
    volumes:
      - .:/app
      - ./lms.env.docker.yml:/app/lms.env.docker.yml
      - logs_data:/app/logs
    depends_on:
      - lms
      - redis
    command: celery -A lms worker --loglevel=info
    networks:
      - edx_network

  # Celery Worker (CMS)
  celery_cms:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: edx_celery_cms
    environment:
      - LMS_CFG=/app/lms.env.docker.yml
      - CMS_CFG=/app/cms.env.docker.yml
      - DJANGO_SETTINGS_MODULE=cms.envs.devstack
    volumes:
      - .:/app
      - ./cms.env.docker.yml:/app/cms.env.docker.yml
      - logs_data:/app/logs
    depends_on:
      - cms
      - redis
    command: celery -A cms worker --loglevel=info
    networks:
      - edx_network

  # Celery Beat (Scheduler)
  celery_beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: edx_celery_beat
    environment:
      - LMS_CFG=/app/lms.env.docker.yml
      - CMS_CFG=/app/cms.env.docker.yml
      - DJANGO_SETTINGS_MODULE=lms.envs.devstack
    volumes:
      - .:/app
      - ./lms.env.docker.yml:/app/lms.env.docker.yml
      - logs_data:/app/logs
    depends_on:
      - lms
      - redis
    command: celery -A lms beat --loglevel=info
    networks:
      - edx_network

volumes:
  mysql_data:
  mongodb_data:
  redis_data:
  staticfiles_data:
  logs_data:

networks:
  edx_network:
    name: edx_network
    driver: bridge

