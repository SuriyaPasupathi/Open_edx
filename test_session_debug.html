<!DOCTYPE html>
<html>
<head>
    <title>Session Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h1>Open edX Session Debug Test</h1>
    <div id="logs"></div>
    
    <button onclick="testLogin()">Test Login</button>
    <button onclick="testDashboard()">Test Dashboard Access</button>
    <button onclick="testSession()">Test Session Status</button>
    <button onclick="clearLogs()">Clear Logs</button>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(logDiv);
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function testLogin() {
            log('üîê Testing login...', 'info');
            
            const formData = new FormData();
            formData.append('email', 'murugadass@gmail.com');
            formData.append('password', 'ChangeMe!2345');
            
            // Get CSRF token first
            fetch('/login', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const csrfToken = doc.querySelector('[name=csrfmiddlewaretoken]')?.value;
                
                if (!csrfToken) {
                    log('‚ùå Could not find CSRF token', 'error');
                    return;
                }
                
                log(`‚úÖ Found CSRF token: ${csrfToken.substring(0, 20)}...`, 'success');
                formData.append('csrfmiddlewaretoken', csrfToken);
                
                // Perform login
                return fetch('/api/user/v1/account/login_session/', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
            })
            .then(response => {
                log(`Login response status: ${response.status}`, response.ok ? 'success' : 'error');
                return response.json();
            })
            .then(data => {
                log(`Login response: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.success) {
                    log('‚úÖ Login successful!', 'success');
                    log(`Redirect URL: ${data.redirect_url}`, 'info');
                    
                    // Test session immediately
                    setTimeout(() => {
                        testSession();
                        testDashboard();
                    }, 1000);
                } else {
                    log('‚ùå Login failed', 'error');
                }
            })
            .catch(error => {
                log(`‚ùå Login error: ${error.message}`, 'error');
            });
        }

        function testDashboard() {
            log('üìä Testing dashboard access...', 'info');
            
            fetch('/dashboard', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => {
                log(`Dashboard response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    log('‚úÖ Dashboard accessible!', 'success');
                    return response.text();
                } else if (response.status === 302) {
                    log('‚ùå Dashboard redirected (likely to login)', 'error');
                    return response.text();
                } else {
                    log(`‚ùå Dashboard error: ${response.status}`, 'error');
                    return response.text();
                }
            })
            .then(html => {
                if (html) {
                    // Check if we got redirected to login
                    if (html.includes('login') || html.includes('signin')) {
                        log('‚ùå Dashboard redirected to login page - session not maintained', 'error');
                    } else if (html.includes('dashboard') || html.includes('Dashboard')) {
                        log('‚úÖ Dashboard content loaded successfully!', 'success');
                    } else {
                        log('‚ö†Ô∏è Dashboard response unclear', 'info');
                    }
                }
            })
            .catch(error => {
                log(`‚ùå Dashboard test error: ${error.message}`, 'error');
            });
        }

        function testSession() {
            log('üç™ Testing session status...', 'info');
            
            // Check if we have session cookie
            const cookies = document.cookie;
            log(`Current cookies: ${cookies}`, 'info');
            
            if (cookies.includes('sessionid')) {
                log('‚úÖ Session cookie found', 'success');
            } else {
                log('‚ùå No session cookie found', 'error');
            }
            
            // Test session endpoint
            fetch('/api/user/v1/account/', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => {
                log(`Session API response status: ${response.status}`, response.ok ? 'success' : 'error');
                return response.json();
            })
            .then(data => {
                log(`Session API response: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.username) {
                    log(`‚úÖ User authenticated: ${data.username}`, 'success');
                } else {
                    log('‚ùå User not authenticated', 'error');
                }
            })
            .catch(error => {
                log(`‚ùå Session test error: ${error.message}`, 'error');
            });
        }

        // Auto-run session test on page load
        window.onload = function() {
            log('üöÄ Session Debug Test loaded', 'info');
            testSession();
        };
    </script>
</body>
</html>